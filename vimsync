#!/bin/sh

bad_option()
{
	usage
	exit 1
}

usage()
{
	printf "USAGE:
	\t./vimsync OPTION
	OPTIONS:
	\t-h       : show this help message
	\t-l       : sync with local files (you need to have cloned the repo for this to work)
	\t-f 	   : force the copy\n
	\t-m       : recompile mpi to install it instead of using the precompiled binaries\n
	\t-d       : Enable dvorak by default\n"
}

local_mode=false
force=false
mpi=false
dvorak=false

while getopts lfhmnd option; do
	case $option in
		(l)
			local_mode=true;;
		(f)
			force=true;;
		(m)
			mpi=true;;
		(d)
			dvorak=true;;
		(h | *)
			bad_option;;
	esac
done

if $force && ! $local_mode; then
	bad_option
fi

if $local_mode; then
	if $force; then
		cp -fr .bashrc .config .local "$HOME"
	else
		cp -ir .bashrc .config .local "$HOME"
	fi

	mkdir -p downloads
	(
		cd downloads

		mkdir -p ~/.local/bin

		# Install latest neovim because university one is super old and doesn't even support lazy.nvim
		wget -nc 'https://github.com/neovim/neovim/releases/download/v0.11.5/nvim-linux-x86_64.tar.gz'
		if ! test -d nvim-linux-x86_64; then
			tar xpf nvim-linux-x86_64.tar.gz
		fi
		cp -r nvim-linux-x86_64 ~/.local/bin
		ln -sf ~/.local/bin/nvim-linux-x86_64/bin/nvim ~/.local/bin/nvim

		if $mpi; then
			openmpi='openmpi-4.1.8'
			wget -nc "https://download.open-mpi.org/release/open-mpi/v4.1/$openmpi.tar.bz2"
			if ! test -d "$openmpi"; then
				tar xpf "$openmpi".tar.bz2
			fi
			(
				cd "$openmpi"
				./configure prefix="$HOME/.local" --disable-debug-symbols --enable-mpi-cxx
				make -j$(nproc) install
			)
		fi

		wget -nc 'https://addons.mozilla.org/firefox/downloads/file/4047348/vimium_c-1.99.995.xpi' 'https://addons.mozilla.org/firefox/downloads/file/3632463/newtab_adapter-1.3.0.xpi'
		setsid -f firefox vimium_c-1.99.995.xpi newtab_adapter-1.3.0.xpi &
	)

	if "$dvorak"; then
		xkbcomp -w 0 "$HOME"/.config/xkb/latin-programmer-dvorak "$DISPLAY"
		xmodmap -e 'keycode 135 = Super_R'
	fi
	printf "\nPlease restart the computer for changes to take effect"
else
	bad_option
fi

#!/bin/sh

#################
### Variables ###
#################

XDG_CONFIG_HOME="$HOME/.config"
XDG_DATA_HOME="$HOME/.local/share"

# I need to implement an argument for the remote option to specify
# the git remote to be used (use getopts)

vimrc_url="https://git.leonardgomez.xyz/leg7/dotfiles/raw/branch/x200/home/user/.config/vim/vimrc"
kwinrc_url="https://git.leonardgomez.xyz/leg7/vimsync/raw/branch/master/kwinrc"
kshortcuts_url="https://git.leonardgomez.xyz/leg7/vimsync/raw/branch/master/kglobalshortcutsrc"
konsole_url="https://git.leonardgomez.xyz/leg7/vimsync/raw/branch/master/nord.colorscheme"
urls="$vimrc_url $kwinrc_url $kshortcuts_url $konsole_url"

#################
### Functions ###
#################

cp_error ()
{
	echo "Error copying config files, aborting"
	exit 1
}

wget_error ()
{
	echo "Error fetching config files, aborting"
	exit 1
}

mv_error ()
{
	echo "Error moving config files, aborting"
	echo "Files that couldn't be moved will be left in this directory"
	exit 1
}

print_help ()
{
	printf "USAGE:
	\t./vimsync OPTION
	OPTIONS:
	\tlocal,  l: sync with local files (you need to have cloned the repo for this to work)
	\tremote, r: sync the configuration remotely (you only need the script for this to work)\n"
}

syntax_error ()
{
	print_help
	exit 1
}

##############
### Import ###
##############

mkdir -p "$XDG_CONFIG_HOME"/vim

case $1 in
	(local | l)
		cp -i ./vimrc          "$XDG_CONFIG_HOME"/vim/vimrc &&
		cp -i kwirc            "$XDG_CONFIG_HOME"/kwinrc &&
		cp -i kglobalshortcuts "$XDG_CONFIG_HOME"/kglobalshortcutsrc &&
		cp -i nord.colorscheme "$XDG_DATA_HOME"/konsole/nord.colorscheme ||
		cp_error
		;;
	(remote | r)
		for url in $urls
		do
			wget -q "$url" || wget_error
		done

		mv -i ./vimrc          "$XDG_CONFIG_HOME"/vim/vimrc &&
		mv -i kwirc            "$XDG_CONFIG_HOME"/kwinrc &&
		mv -i kglobalshortcuts "$XDG_CONFIG_HOME"/kglobalshortcutsrc &&
		mv -i nord.colorscheme "$XDG_DATA_HOME"/konsole/nord.colorscheme ||
		mv_error
		;;
	(*)
		syntax_error
		;;
esac

#################
### Configure ###
#################

# I should make the bashrc source a shell script with my config instead

# We export these variables for later shell sessions
{ echo 'export XDG_CONFIG_HOME="$HOME/.config"';
echo 'export XDG_DATA_HOME="$HOME/.local/share"';
echo 'export XDG_CACHE_HOME="$HOME/.local/cache"';
echo 'export VIMINIT="set nocp | source ${XDG_CONFIG_HOME:-$HOME/.config}/vim/vimrc"';
echo 'konsoleprofile colors=nord' ; } >> "$HOME"/.bashrc

# Add vi mode to bash and change keyboard settings. Just press 1 or 9 to change the layout if needed
setxkbmap -layout us -variant dvp -option caps:swapescape
{ echo "set -o vi";
echo 'alias 9="setxkbmap fr -option caps:swapescape"';
echo 'alias 1="setxkbmap -layout us -variant dvp -option caps:swapescape"'; } >> "$HOME"/.bashrc

# We need to do this to source the new bashrc
killall konsole && konsole &
kwinrc --replace &
